resources:
  repositories:
    - repository: facet
      type: github
      endpoint: konst-int-i # todo - update to final github org
      name: konst-int-i/facet # todo - update to final github org
      ref: develop


trigger:
- master
- releases/*

stages:
  - stage: 'Setup_and_testing'
    displayName: 'Setup & testing'

    jobs:
    - job:
      displayName: 'Setup & testing'

      variables:
      - group: git-credentials
      pool:
          vmImage: 'ubuntu-latest'
      strategy:
        matrix:
          Python35:
            python.version: '3.5'
          Python38:
            python.version: '3.8'

      steps:
        - task: UsePythonVersion@0
          inputs:
            versionSpec: '$(python.version)'
          displayName: 'Use Python $(python.version)'

        - checkout: self
        - checkout: facet
        - script: dir $(Build.SourcesDirectory)

        - task: Bash@3
          inputs:
            targetType: 'inline'
            script: |
              eval "$(conda shell.bash hook)"
              cd $(System.DefaultWorkingDirectory)/facet/
              export PYTHONPATH=$(System.DefaultWorkingDirectory)/pytools/
              conda env create -f environment.yml
              conda activate facet-develop
              cd $(System.DefaultWorkingDirectory)/pytools/
              make package
              coverage run -m pytest test/test/
              coverage xml
              coverage html
          displayName: "Install env and build conda package"

        - task: PublishTestResults@2
          condition: succeededOrFailed()
          inputs:
            testResultsFiles: '$(System.DefaultWorkingDirectory)/pytools/*.xml'
            searchFolder: '$(System.DefaultWorkingDirectory)/pytools/'
            testRunTitle: 'Publish test results'

        - task: PublishCodeCoverageResults@1
          inputs:
            codeCoverageTool: Cobertura
            summaryFileLocation: '$(System.DefaultWorkingDirectory)/pytools/coverage.xml'
            reportDirectory: '$(System.DefaultWorkingDirectory)/pytools/htmlcov'

#        - task: Bash@3 TODO - include once packages are public
#          inputs:
#            targetType: 'inline'
#            script: |
#              eval "$(conda shell.bash hook)"
#              conda activate facet-develop
#              cd /home/vsts/work/1/s/pytools/
#              make package
#          displayName: "Build conda package"