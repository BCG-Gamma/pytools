resources:
  repositories:
    - repository: facet
      type: github
      endpoint: konst-int-i # todo - update to final github org
      name: konst-int-i/facet # todo - update to final github org
      ref: develop

trigger:
- master
- releases/*

pool:
  vmImage: 'ubuntu-latest'
strategy:
  matrix:
    Python35:
      python.version: '3.5'
    Python36:
      python.version: '3.6'
    Python37:
      python.version: '3.7'

stages:
  - stage: 'Setup & testing'
    displayName: 'Setup & testing'

    jobs:
    - job:
      displayName: 'Setup & testing'
      pool:
          vmImage: 'ubuntu-latest'

      steps:
        - task: UsePythonVersion@0
          inputs:
            versionSpec: '$(python.version)'
          displayName: 'Use Python $(python.version)'

        - checkout: self
        - checkout: facet
        - script: dir $(Build.SourcesDirectory)

        - task: Bash@3
          inputs:
            targetType: 'inline'
            script: |
              eval "$(conda shell.bash hook)"
              cd /home/vsts/work/1/s/facet/
              conda env create -f environment.yml
              conda activate facet-develop
              cd /home/vsts/work/1/s/pytools/
              export PYTHONPATH=./src/
              pip install pytest-azurepipelines
              pytest test/test/
          displayName: "Install env and run pytest"


        - task: Bash@3
          script: |
            conda activate facet-develop
            make package
          displayName: "Build conda package"
